---
- name: Resolve service user uid for deploy runtime context
  ansible.builtin.command: "id -u {{ ats_service_user }}"
  register: ats_deploy_service_user_uid
  changed_when: false

- name: Build deploy XDG runtime directory path
  ansible.builtin.set_fact:
    ats_deploy_xdg_runtime_dir: "/run/user/{{ ats_deploy_service_user_uid.stdout }}"

- name: Validate runtime command compatibility with supported startup composition
  ansible.builtin.assert:
    that:
      - ats_runtime_services.bot_api.command == ats_runtime_supported_service_commands.bot_api
      - ats_runtime_services.bot_matrix.command == ats_runtime_supported_service_commands.bot_matrix
      - ats_runtime_services.worker.command == ats_runtime_supported_service_commands.worker
    fail_msg: >-
      Configured runtime commands diverge from supported startup composition.
      Align `ats_runtime_services` with declared supported commands before deploy.

- name: Pull runtime images for configured services
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: >-
    docker compose
    --project-name {{ ats_runtime_compose_project_name }}
    --file {{ ats_runtime_compose_file }}
    pull --policy {{ ats_runtime_pull_policy }} {{ ats_runtime_deploy_services | join(' ') }}
  args:
    chdir: "{{ ats_runtime_root }}"
  environment:
    XDG_RUNTIME_DIR: "{{ ats_deploy_xdg_runtime_dir }}"
  changed_when: false

- name: Ensure postgres is started for migrations
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: >-
    docker compose
    --project-name {{ ats_runtime_compose_project_name }}
    --file {{ ats_runtime_compose_file }}
    up -d postgres
  register: ats_deploy_postgres_up_result
  args:
    chdir: "{{ ats_runtime_root }}"
  environment:
    XDG_RUNTIME_DIR: "{{ ats_deploy_xdg_runtime_dir }}"
  changed_when: >-
    'Created' in ats_deploy_postgres_up_result.stdout
    or 'Started' in ats_deploy_postgres_up_result.stdout
    or 'Recreated' in ats_deploy_postgres_up_result.stdout

- name: Execute database migrations
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: >-
    docker compose
    --project-name {{ ats_runtime_compose_project_name }}
    --file {{ ats_runtime_compose_file }}
    run --rm bot-api uv run alembic upgrade head
  args:
    chdir: "{{ ats_runtime_root }}"
  environment:
    XDG_RUNTIME_DIR: "{{ ats_deploy_xdg_runtime_dir }}"
  changed_when: true

- name: Start runtime services in detached mode
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: >-
    docker compose
    --project-name {{ ats_runtime_compose_project_name }}
    --file {{ ats_runtime_compose_file }}
    up {{ ats_runtime_up_flags }} {{ ats_runtime_deploy_services | join(' ') }}
  register: ats_deploy_up_result
  args:
    chdir: "{{ ats_runtime_root }}"
  environment:
    XDG_RUNTIME_DIR: "{{ ats_deploy_xdg_runtime_dir }}"
  changed_when: >-
    'Created' in ats_deploy_up_result.stdout
    or 'Started' in ats_deploy_up_result.stdout
    or 'Recreated' in ats_deploy_up_result.stdout
